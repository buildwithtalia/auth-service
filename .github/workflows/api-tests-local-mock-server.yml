name: API Tests with Login and Logout Services

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  run-collection:
    name: Run Postman API Tests with Login and Logout Services
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:5.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password123
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'quit(db.runCommand({ ping: 1 }).ok ? 0 : 2)' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cleanup ports 3001 and 3002
        run: |
          echo "üßπ Cleaning up any existing processes on ports 3001 and 3002..."

          # Kill any existing Node.js server processes from previous runs
          pkill -f "login-service" 2>/dev/null || true
          pkill -f "logout-service" 2>/dev/null || true

          # Aggressive cleanup of ports 3001 and 3002
          for port in 3001 3002; do
            echo "Cleaning up port $port..."
            if lsof -ti:$port >/dev/null 2>&1; then
              echo "Found processes on port $port, killing them..."
              lsof -ti:$port | xargs -r kill -9 2>/dev/null || true
            fi
          done

          # Wait for cleanup
          sleep 2

          # Verify ports are available
          for port in 3001 3002; do
            if lsof -ti:$port >/dev/null 2>&1; then
              echo "‚ùå Failed to free port $port after cleanup"
              echo "Processes still using port $port:"
              lsof -i:$port
              exit 1
            else
              echo "‚úÖ Port $port is available"
            fi
          done

      - name: Install dependencies for both services
        run: |
          echo "üì¶ Installing dependencies for login service..."
          cd login-service
          npm install

          echo "üì¶ Installing dependencies for logout service..."
          cd ../logout-service
          npm install

      - name: Start Login Service
        run: |
          echo "üöÄ Starting Login Service on port 3001..."
          cd login-service

          # Create .env file if it doesn't exist
          if [ ! -f .env ]; then
            cp .env.example .env
          fi

          # Start the login service in background
          npm start &
          LOGIN_PID=$!
          echo $LOGIN_PID > ../login-service.pid

          echo "Login Service PID: $LOGIN_PID"
          echo "Waiting for login service to start..."
          sleep 10
        env:
          NODE_ENV: test
          PORT: 3001
          MONGODB_URI: mongodb://admin:password123@localhost:27017/login-service?authSource=admin

      - name: Start Logout Service
        run: |
          echo "üöÄ Starting Logout Service on port 3002..."
          cd logout-service

          # Create .env file if it doesn't exist
          if [ ! -f .env ]; then
            cp .env.example .env
          fi

          # Start the logout service in background
          npm start &
          LOGOUT_PID=$!
          echo $LOGOUT_PID > ../logout-service.pid

          echo "Logout Service PID: $LOGOUT_PID"
          echo "Waiting for logout service to start..."
          sleep 10
        env:
          NODE_ENV: test
          PORT: 3002
          MONGODB_URI: mongodb://admin:password123@localhost:27017/login-service?authSource=admin

      - name: Wait for services to be ready
        run: |
          echo "üîç Waiting for services to be ready..."

          # Wait for Login Service (port 3001)
          echo "Checking Login Service on port 3001..."
          timeout=60
          while ! curl -s http://localhost:3001/health > /dev/null 2>&1; do
            sleep 2
            timeout=$((timeout - 2))
            if [ $timeout -le 0 ]; then
              echo "‚ùå Login service failed to start within 60 seconds"
              echo "Login service logs:"
              if [ -f login-service.pid ]; then
                ps -p $(cat login-service.pid) || echo "Login service process not found"
              fi
              echo "Port 3001 status:"
              lsof -ti:3001 || echo "No process found on port 3001"
              exit 1
            fi
          done
          echo "‚úÖ Login Service is ready on port 3001!"

          # Wait for Logout Service (port 3002)
          echo "Checking Logout Service on port 3002..."
          timeout=60
          while ! curl -s http://localhost:3002/health > /dev/null 2>&1; do
            sleep 2
            timeout=$((timeout - 2))
            if [ $timeout -le 0 ]; then
              echo "‚ùå Logout service failed to start within 60 seconds"
              echo "Logout service logs:"
              if [ -f logout-service.pid ]; then
                ps -p $(cat logout-service.pid) || echo "Logout service process not found"
              fi
              echo "Port 3002 status:"
              lsof -ti:3002 || echo "No process found on port 3002"
              exit 1
            fi
          done
          echo "‚úÖ Logout Service is ready on port 3002!"

          # Test service endpoints
          echo "üß™ Testing service endpoints..."
          echo "Login Service health check:"
          curl -s http://localhost:3001/health | head -c 200
          echo ""
          echo "Logout Service health check:"
          curl -s http://localhost:3002/health | head -c 200
          echo ""

      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/canary/unix.sh" | sh

      - name: Verify Postman CLI version
        run: postman --version

      - name: Login to Postman CLI
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      - name: Create results directory
        run: mkdir -p newman

      - name: Run Postman Collection with Live Services
        continue-on-error: true
        run: |
          echo "üß™ Running Postman collection tests against live services..."
          echo "üìÅ Using local collection: postman/collections/Auth Service API.postman_collection.json"
          echo "üîß Service URLs:"
          echo "  - Login Service: http://localhost:3001"
          echo "  - Logout Service: http://localhost:3002"
          echo "  - loginServicePort=3001"
          echo "  - logoutServicePort=3002"
          echo ""

          # Create environment file with live service URLs
          cat > live-services-environment.json << 'EOF'
          {
            "id": "live-services-env-001",
            "name": "Live Services",
            "values": [
              {
                "key": "baseUrl",
                "value": "http://localhost",
                "type": "default",
                "enabled": true
              },
              {
                "key": "loginServicePort",
                "value": "3001",
                "type": "default",
                "enabled": true
              },
              {
                "key": "logoutServicePort",
                "value": "3002",
                "type": "default",
                "enabled": true
              }
            ],
            "_postman_variable_scope": "environment"
          }
          EOF

          postman collection run "postman/collections/Auth Service API.postman_collection.json" --report-events \
            --environment "live-services-environment.json"

      - name: Lint API Specification
        run: postman spec lint "postman/specs/auth-service-api.yaml"

      - name: Stop Services
        if: always()
        run: |
          echo "üõë Stopping services..."

          # Stop Login Service
          if [ -f login-service.pid ]; then
            echo "Stopping Login Service..."
            LOGIN_PID=$(cat login-service.pid)
            kill $LOGIN_PID 2>/dev/null || kill -9 $LOGIN_PID 2>/dev/null || true
            rm login-service.pid
            echo "‚úÖ Login Service stopped"
          fi

          # Stop Logout Service
          if [ -f logout-service.pid ]; then
            echo "Stopping Logout Service..."
            LOGOUT_PID=$(cat logout-service.pid)
            kill $LOGOUT_PID 2>/dev/null || kill -9 $LOGOUT_PID 2>/dev/null || true
            rm logout-service.pid
            echo "‚úÖ Logout Service stopped"
          fi

          # Kill any remaining service processes
          pkill -f "login-service" 2>/dev/null || true
          pkill -f "logout-service" 2>/dev/null || true

          # Ensure no processes remain on ports 3001 and 3002
          for port in 3001 3002; do
            if lsof -ti:$port >/dev/null 2>&1; then
              echo "Cleaning up remaining processes on port $port..."
              lsof -ti:$port | xargs -r kill -9 2>/dev/null || true
            fi
          done

          # Wait for cleanup
          sleep 3

          # Clean up temporary files
          rm -f live-services-environment.json

          # Verify cleanup
          for port in 3001 3002; do
            if lsof -ti:$port >/dev/null 2>&1; then
              echo "‚ö†Ô∏è Warning: Port $port may still be in use"
              lsof -ti:$port | xargs -r ps -p
            else
              echo "‚úÖ Port $port is now free"
            fi
          done

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postman-test-results-live-services
          path: |
            newman/test-results.json
            newman/test-results.html
          if-no-files-found: warn

      - name: Display test summary
        if: always()
        run: |
          if [ -f newman/test-results.json ]; then
            echo "‚úÖ Test results generated successfully"
            echo "üìä Check the artifacts for detailed HTML and JSON reports"
            echo "üéØ Tests ran against live services:"
            echo "   - Login Service: http://localhost:3001"
            echo "   - Logout Service: http://localhost:3002"
          else
            echo "‚ùå Test results were not generated"
          fi
